version: '3.8'

services:
  # ----------------------------------------------------------------
  # 1. CORE INFRASTRUCTURE
  # ----------------------------------------------------------------
  swasthya-postgres:
    image: postgres:15
    container_name: swasthya-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # Mount initialization scripts to auto-create schemas on first startup
      - ./data:/docker-entrypoint-initdb.d
    ports:
      - "${POSTGRES_PORT}:5432"
    networks:
      - swasthya-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5

  swasthya-mlflow:
    build: ./mlflow
    container_name: swasthya-mlflow
    depends_on:
      - swasthya-postgres
    environment:
      BACKEND_STORE_URI: postgresql://${MLFLOW_DB_USER}:${MLFLOW_DB_PASSWORD}@swasthya-postgres:5432/${MLFLOW_DB_NAME}
      ARTIFACT_ROOT: /mlflow/artifacts
    ports:
      - "${MLFLOW_PORT}:5000"
    volumes:
      - mlflow_data:/mlflow/artifacts
    networks:
      - swasthya-net
    command: >
      mlflow server 
      --backend-store-uri postgresql://${MLFLOW_DB_USER}:${MLFLOW_DB_PASSWORD}@swasthya-postgres:5432/${MLFLOW_DB_NAME} 
      --host 0.0.0.0 
      --port 5000

  # ----------------------------------------------------------------
  # 2. ORCHESTRATOR (Node.js)
  # ----------------------------------------------------------------
  swasthya-orchestrator:
    build: ./orchestrator
    container_name: swasthya-orchestrator
    depends_on:
      swasthya-postgres:
        condition: service_healthy
      swasthya-demand-forecast:
        condition: service_started
    environment:
      - PORT=${ORCHESTRATOR_PORT}
      - DB_HOST=${POSTGRES_HOST}
      - DB_USER=${POSTGRES_USER}
      - DB_PASS=${POSTGRES_PASSWORD}
      - DB_NAME=${POSTGRES_DB}
      - MLFLOW_TRACKING_URI=${MLFLOW_TRACKING_URI}
      # Agent URLs
      - AGENT_DEMAND_URL=http://swasthya-demand-forecast:8001
      - AGENT_STAFF_URL=http://swasthya-staff-scheduling:8002
      - AGENT_EROR_URL=http://swasthya-eror-scheduling:8003
      - AGENT_DISCHARGE_URL=http://swasthya-discharge-planning:8004
      - AGENT_TRIAGE_URL=http://swasthya-triage-acuity:8005
    ports:
      - "${ORCHESTRATOR_PORT}:${ORCHESTRATOR_PORT}"
    networks:
      - swasthya-net

  # ----------------------------------------------------------------
  # 3. AI AGENTS (Python Microservices)
  # ----------------------------------------------------------------
  swasthya-demand-forecast:
    build: ./agents/demand_forecast
    container_name: swasthya-demand-forecast
    environment:
      - PORT=8001
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}/${POSTGRES_DB}
      - MLFLOW_TRACKING_URI=${MLFLOW_TRACKING_URI}
    ports:
      - "${PORT_DEMAND_FORECAST}:8001"
    networks:
      - swasthya-net

  swasthya-staff-scheduling:
    build: ./agents/staff_scheduling
    container_name: swasthya-staff-scheduling
    environment:
      - PORT=8002
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}/${POSTGRES_DB}
    ports:
      - "${PORT_STAFF_SCHEDULING}:8002"
    networks:
      - swasthya-net

  swasthya-eror-scheduling:
    build: ./agents/eror_scheduling
    container_name: swasthya-eror-scheduling
    environment:
      - PORT=8003
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}/${POSTGRES_DB}
    ports:
      - "${PORT_EROR_SCHEDULING}:8003"
    networks:
      - swasthya-net

  swasthya-discharge-planning:
    build: ./agents/discharge_planning
    container_name: swasthya-discharge-planning
    environment:
      - PORT=8004
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}/${POSTGRES_DB}
      - MLFLOW_TRACKING_URI=${MLFLOW_TRACKING_URI}
    ports:
      - "${PORT_DISCHARGE_PLANNING}:8004"
    networks:
      - swasthya-net

  swasthya-triage-acuity:
    build: ./agents/triage_acuity
    container_name: swasthya-triage-acuity
    environment:
      - PORT=8005
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}/${POSTGRES_DB}
      - MLFLOW_TRACKING_URI=${MLFLOW_TRACKING_URI}
    ports:
      - "${PORT_TRIAGE_ACUITY}:8005"
    networks:
      - swasthya-net

  # ----------------------------------------------------------------
  # 4. FEDERATED LEARNING SERVERS
  # ----------------------------------------------------------------
  # Demand Forecasting FL Server (Port 8087)
  # Coordinates Prophet model training across hospitals
  fl-demand-server:
    build:
      context: ./federated_learning
      dockerfile: Dockerfile.server
    container_name: fl-demand-server
    environment:
      - FL_SERVER_ADDRESS=0.0.0.0:${FL_DEMAND_PORT:-8087}
      - FL_NUM_ROUNDS=${FL_NUM_ROUNDS:-5}
      - FL_MIN_FIT_CLIENTS=${FL_MIN_CLIENTS:-2}
      - FL_MIN_EVAL_CLIENTS=${FL_MIN_CLIENTS:-2}
      - FL_MODEL_SAVE_PATH=/models
    command: python -m server.demand_server --address 0.0.0.0:${FL_DEMAND_PORT:-8087}
    ports:
      - "${FL_DEMAND_PORT:-8087}:${FL_DEMAND_PORT:-8087}"
    volumes:
      - fl_models:/models
    networks:
      - swasthya-net
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; s=socket.socket(); s.settimeout(5); s.connect(('localhost', ${FL_DEMAND_PORT:-8087})); s.close()"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3

  # Triage Prediction FL Server (Port 8086)
  # Coordinates XGBoost model training across hospitals
  fl-triage-server:
    build:
      context: ./federated_learning
      dockerfile: Dockerfile.server
    container_name: fl-triage-server
    environment:
      - FL_TRIAGE_SERVER_ADDRESS=0.0.0.0:${FL_TRIAGE_PORT:-8086}
      - FL_NUM_ROUNDS=${FL_NUM_ROUNDS:-5}
      - FL_MIN_FIT_CLIENTS=${FL_MIN_CLIENTS:-2}
      - FL_MIN_EVAL_CLIENTS=${FL_MIN_CLIENTS:-2}
      - FL_MODEL_SAVE_PATH=/models
    command: python -m server.triage_server --address 0.0.0.0:${FL_TRIAGE_PORT:-8086}
    ports:
      - "${FL_TRIAGE_PORT:-8086}:${FL_TRIAGE_PORT:-8086}"
    volumes:
      - fl_models:/models
    networks:
      - swasthya-net
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; s=socket.socket(); s.settimeout(5); s.connect(('localhost', ${FL_TRIAGE_PORT:-8086})); s.close()"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3

  # ----------------------------------------------------------------
  # 5. FEDERATED LEARNING CLIENTS (Hospital Simulation)
  # ----------------------------------------------------------------
  # Each client represents a hospital with local data
  # Data sovereignty: patient data never leaves the container
  
  # Demand Forecast Clients (Training Prophet locally)
  fl-demand-client-1:
    build:
      context: ./federated_learning
      dockerfile: Dockerfile.client
    container_name: fl-demand-client-hospital-alpha
    environment:
      - HOSPITAL_ID=hospital_alpha
      - FL_SERVER_ADDRESS=fl-demand-server:${FL_DEMAND_PORT:-8087}
      - FL_LOCAL_EPOCHS=1
      - FL_MAX_RETRIES=15
      - FL_RETRY_DELAY=5.0
    command: python -m client.demand_client --server fl-demand-server:${FL_DEMAND_PORT:-8087} --hospital-id hospital_alpha
    volumes:
      - ./datasets:/data:ro  # Read-only mount for data sovereignty
    depends_on:
      - fl-demand-server
    networks:
      - swasthya-net

  fl-demand-client-2:
    build:
      context: ./federated_learning
      dockerfile: Dockerfile.client
    container_name: fl-demand-client-hospital-beta
    environment:
      - HOSPITAL_ID=hospital_beta
      - FL_SERVER_ADDRESS=fl-demand-server:${FL_DEMAND_PORT:-8087}
      - FL_LOCAL_EPOCHS=1
      - FL_MAX_RETRIES=15
    command: python -m client.demand_client --server fl-demand-server:${FL_DEMAND_PORT:-8087} --hospital-id hospital_beta
    volumes:
      - ./datasets:/data:ro
    depends_on:
      - fl-demand-server
    networks:
      - swasthya-net

  fl-demand-client-3:
    build:
      context: ./federated_learning
      dockerfile: Dockerfile.client
    container_name: fl-demand-client-hospital-gamma
    environment:
      - HOSPITAL_ID=hospital_gamma
      - FL_SERVER_ADDRESS=fl-demand-server:${FL_DEMAND_PORT:-8087}
      - FL_LOCAL_EPOCHS=1
      - FL_MAX_RETRIES=15
    command: python -m client.demand_client --server fl-demand-server:${FL_DEMAND_PORT:-8087} --hospital-id hospital_gamma
    volumes:
      - ./datasets:/data:ro
    depends_on:
      - fl-demand-server
    networks:
      - swasthya-net

  # Triage Prediction Clients (Training XGBoost locally)
  fl-triage-client-1:
    build:
      context: ./federated_learning
      dockerfile: Dockerfile.client
    container_name: fl-triage-client-hospital-alpha
    environment:
      - HOSPITAL_ID=hospital_alpha
      - FL_TRIAGE_SERVER_ADDRESS=fl-triage-server:${FL_TRIAGE_PORT:-8086}
      - FL_LOCAL_EPOCHS=1
      - FL_MAX_RETRIES=15
    command: python -m client.triage_client --server fl-triage-server:${FL_TRIAGE_PORT:-8086} --hospital-id hospital_alpha
    volumes:
      - ./datasets:/data:ro
    depends_on:
      - fl-triage-server
    networks:
      - swasthya-net

  fl-triage-client-2:
    build:
      context: ./federated_learning
      dockerfile: Dockerfile.client
    container_name: fl-triage-client-hospital-beta
    environment:
      - HOSPITAL_ID=hospital_beta
      - FL_TRIAGE_SERVER_ADDRESS=fl-triage-server:${FL_TRIAGE_PORT:-8086}
      - FL_LOCAL_EPOCHS=1
      - FL_MAX_RETRIES=15
    command: python -m client.triage_client --server fl-triage-server:${FL_TRIAGE_PORT:-8086} --hospital-id hospital_beta
    volumes:
      - ./datasets:/data:ro
    depends_on:
      - fl-triage-server
    networks:
      - swasthya-net

  fl-triage-client-3:
    build:
      context: ./federated_learning
      dockerfile: Dockerfile.client
    container_name: fl-triage-client-hospital-gamma
    environment:
      - HOSPITAL_ID=hospital_gamma
      - FL_TRIAGE_SERVER_ADDRESS=fl-triage-server:${FL_TRIAGE_PORT:-8086}
      - FL_LOCAL_EPOCHS=1
      - FL_MAX_RETRIES=15
    command: python -m client.triage_client --server fl-triage-server:${FL_TRIAGE_PORT:-8086} --hospital-id hospital_gamma
    volumes:
      - ./datasets:/data:ro
    depends_on:
      - fl-triage-server
    networks:
      - swasthya-net

networks:
  swasthya-net:
    driver: bridge

volumes:
  postgres_data:
  mlflow_data:
  fl_models:
